{% extends 'layout/base.html' %}

{% block title %}Add New Project{% endblock %}

<!-- Konten Halaman  -->

<!-- Modifikasi di sini -->
{% block content %}

<div class="col-lg-12">
    <div class="col-xl">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <!-- <h5 class="mb-0"></h5> -->
                <h4 class="mb-0 text-primary"> Tambah Proyek Baru</h4> 
                <small class="text-muted float-end"></small>
            </div>
            <div class="card-body">
                <form id="project-form">
                    <div class="mb-3">
                        <label class="form-label text-primary" for="basic-default-fullname">Nama Proyek</label>
                        <input type="text" class="form-control" id="basic-default-fullname" name="nama_proyek"
                            placeholder="Penilaian Kinerja" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-primary" for="basic-default-message">Deskripsi Proyek</label>
                        <textarea id="basic-default-message" class="form-control" name="deskripsi"
                            placeholder="Deskripsi Proyek"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="flatpickr-range" class="form-label text-primary">Periode Partisipan</label>
                        <input type="text" class="form-control" name="periode_mulai" placeholder="YYYY-MM-DD to YYYY-MM-DD"
                            id="flatpickr-range" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-primary" for="basic-default-respondents">Jumlah Responden</label>
                        <input type="number" class="form-control" id="basic-default-respondents" name="jumlah_responden" placeholder="Masukan jumlah responden yang akan berpartisipasi" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-primary" for="num-criteria">Jumlah Kriteria</label>
                        <input type="number" class="form-control" id="num-criteria" name="jumlah_kriteria" placeholder="Masukan jumlah kriteria yang akan dinilai" />
                    </div>
                    
                    <div class="card mt-4" id="criteria-card">
                        <div class="card-body">
                            <div id="criteria-container"></div>
                        </div>
                    </div><br />

                    <button type="button" onclick="resetForm()" class="btn btn-danger" style="margin-right: 10px;">Reset</button>  
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript untuk menambahkan textbox sesuai jumlah kriteria -->
<script>
    // Tunggu sampai DOM selesai dimuat
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('criteria-card').style.visibility = 'hidden'
        var numCriteriaInput = document.getElementById('num-criteria');
        var criteriaContainer = document.getElementById('criteria-container');
        var criteriaCard = document.getElementById('criteria-card'); // Card untuk kriteria

        // Listener untuk input jumlah kriteria
        numCriteriaInput.addEventListener('input', function () {
            var numCriteria = parseInt(numCriteriaInput.value) ||
                0; // Menghindari NaN jika input kosong
            criteriaContainer.innerHTML = ''; // Bersihkan input sebelumnya

            // Menambah textbox sesuai jumlah kriteria
            for (var i = 0; i < numCriteria; i++) {
                var inputGroup = document.createElement('div');
                inputGroup.classList.add('mb-3'); // Memberikan jarak antar input

                var label = document.createElement('label');
                label.classList.add('form-label');
                label.textContent = 'Kriteria ' + (i + 1);
                inputGroup.appendChild(label);

                var input = document.createElement('input');
                input.type = 'text';
                input.classList.add('form-control');
                input.placeholder = 'Masukkan Kriteria ' + (i + 1);
                inputGroup.appendChild(input);

                criteriaContainer.appendChild(inputGroup);
            }

            // Menampilkan card kriteria hanya jika ada kriteria yang dimasukkan
            if (numCriteria > 0) {
                document.getElementById('criteria-card').style.visibility = 'visible'
                criteriaCard.style.display = 'block'; // Menampilkan card kriteria
            } else {
                criteriaCard.style.display = 'none'; // Menyembunyikan card jika tidak ada kriteria
            }
        });
    });

    document.getElementById('project-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        var formData = new FormData(this);

        var criteriaContainer = document.getElementById('criteria-container');
        var criteria = criteriaContainer.children;

        for (var i = 0; i < criteria.length; i++) {
            var input = criteria[i].children[1];
            formData.append('kriteria[]', input.value);
        }

        try{
            var response = await fetch('/proyek', {
                method: 'POST',
                body: formData
            })
            var result = await response.json()
            if(response.ok){
                Swal.fire({
                    title: 'Sukses!',
                    text: result.message,
                    icon: 'success',
                    customClass: {
                        confirmButton: 'btn btn-primary waves-effect waves-light'
                    },
                    buttonsStyling: false
                });
                setTimeout(() => {
                    window.location.href = '/listProjectOwner'
                }, 2000);
            }else{
                Swal.fire({
                    title: 'Oops!',
                    text: 'Data gagal disimpan.',
                    icon: 'error',
                    customClass: {
                        confirmButton: 'btn btn-primary waves-effect waves-light'
                    },
                    buttonsStyling: false
                });
            }
        } catch (error) {
            Swal.fire({
                title: 'Perhatian!',
                text: 'Terjadi kesalahan. Silahkan hubungi administrator!',
                icon: 'warning',
                customClass: {
                    confirmButton: 'btn btn-primary waves-effect waves-light'
                },
                buttonsStyling: false
            });
        }
    });
    
    function resetForm(){
        document.getElementById('project-form').reset()
        document.getElementById('flatpickr-range').flatpickr().clear()
    }

</script>

{% endblock %}